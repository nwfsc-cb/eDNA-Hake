---
title: "Run 20210518"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
library(eDNAfuns)
library(here)
library(googlesheets4)
```

# Taking samples from a few places:

THe last run, the nano run, and cols 13&14 from the first run

```{r}
#gs4_find()

PCR57 <- read_indexing_PCR("1tJwmPWZ2Ruog4gOAfnQHfFoYsy-WApAZ2oRC_JFOLMQ")
PCR67 <- read_indexing_PCR("1MB_hyVKw4PfFGNfNm211DUBVpzICwKL-QR8-lFpBXE8")
PCR73 <- read_indexing_PCR("1My_iMO1zjiGw_Drr8NJAMA9t_sKjL2XIhvfZFLYwz4M")

PCR57 %>% 
  filter (str_detect(Well, "01|02")) %>% 
  filter (!is.na(Sample)) -> Adding57

PCR67 %>% 
  filter (!is.na(Sample)) -> Adding67

PCR73 %>% 
  filter (!is.na(Sample)) -> Adding73

Adding73 %>% 
  mutate(Barcode = Well)-> Adding73
# Have I reused.any

list (Adding57, Adding67, Adding73) %>% set_names(nm = list("PCR57", "PCR67", "PCR73")) %>% bind_rows(.id = "PCR") -> all.together

all.together %>% 
  unite(Set, Barcode, col = "Unique") %>% 
  group_by(Unique) %>% 
  summarise (n = n())

```

Cool - Prepare a metadata file and Generate the Sample Sheet and metadata file
You need an input file with at least the following columns:

  - Sample_name: Avoid spaces - for compatibility with MiSeq's sample sheet, use hyphen "-" instead of underscores "_" or full stops "."
  - Well:  in the 96-well plate used for the Nextera reaction. If you are using UDI indices, and select the option `Matching with well`,  then this field MUST match that of the UDI plate you are using.
  - Set: Use A,B,C,D or 1,2,3,4. Crucial for the UDI plate
  - PrimerF: using IUPAC wildcard character
  - PrimerR: ditto
  - Locus: Name of the locus, again without spaces.
  - i7_Index_Name: Adapter used to identify samples. Format is N7XX for the Nextera. 
  - i5_Index_Name: Adapter used to identify samples. Format is N5XX for the Nextera.
  - UDI_Index_Name: Adapter used to identify samples with the UDI. Format is  UDPXXXX

```{r}
all.together %>% 
  separate(Sample, into = c("Sample_name", "replicate")) %>% 
  group_by(Sample_name) %>% 
  nest() %>% 
  mutate(data = map(data, ~.x %>% rownames_to_column("rep"))) %>% 
  unnest(data) %>% 
  unite(Sample_name, rep, col = "Sample_name", sep = "-") %>% 
  mutate(Well = Barcode) %>% 
  select(-Barcode, -replicate, -PCR) %>% 
  mutate(PrimerF = "GYAATCACTTGTCTTTTAAATGAAGACC",
         PrimerR = "GGATTGCGCTGTTATCCCTA",
         Locus = "16S_Prey") %>% 
  write_csv(here("Data", "Lab_books", "metadata_input_20210518.csv"))
  
  
```

# Check uniques

```{r}
read_csv(here("Data", "FASTQ_raw/Run7_20210518/metadata_2021-05-18.csv")) %>% 
  group_by(i5_Index_Name) %>% 
  tally() %>% 
  filter (n>1)


```

All good