---
title: "Statistics Plan"
output: html_notebook
---

We have a sampling design that includes eDNA samples from three strata of the water column from each sampling station: water above and below the thermocline, and deep water closer to the sea floor. These stations are grouped in several longitudinal (onshore - offshore)  transects. Some of the stations are close to shore, and some are far offshore. In certain onshore localities, the strength of the upwelling of deep water might disturb the thermocline and bring deep water (and here comes the hypothesis) with its own eDNA. How to test the influence of deep water eDNA in a suface sample?

# Whole communities vs single taxa

Two layers of evidence can be used:

  * single species information, from those species that are well known to dwell in deeper waters, and not to take part in the Daily Vertical Migration.
  * Whole community assemblages: We will expect some level of mixing between deep water and surface water, but how to formally test it? Within each transect, we will expect that:
      - the similarity (based on a Bray-Curtis dissimilarity matrix on the normalized reads calculated on the eDNAindex from Kelly et al 2018) between samples from above and below the thermocline will be greater in places where the thermocline is weaker (so more mixing) AND
      - the similarity between these uppermost samples and the deep water will be greater when there is strong upwelling AND
      - this similarity is likely driven by deep water species

```{r}
library (tidyverse)
library(here)
library(eDNAfuns)
library(vegan)
library (patchwork)
```

## Combine 
## Combine Miseq runs with classification
```{r}
ASV.after.cleanup <- read_csv(here("Output","ASV_table_all_together.csv"))
Hashs.classified <- read_csv(here("Data","Pipeline_output","Run8","output","hash.classified.csv")) %>% 
  bind_rows(read_csv(here("Data","Pipeline_output","Run7","output_no_MaxEE","hash.classified.csv"))) %>% 
  distinct()
Hashs.classified %>% 
  group_by(representative) %>% 
  tally(sort = T)

ASV.after.cleanup %>% 
  anti_join(Hashs.classified, by = c("Hash" = "representative")) # All Hashes classified

ASV.after.cleanup %>% 
  left_join(Hashs.classified, by = c("Hash" = "representative")) %>% 
  unite(family, genus, species, col = "taxon", sep = "%" ) %>% 
  #select (Miseq_run, Sample_name, nReads, taxon) %>% 
  group_by(Sample_name, taxon) %>% 
  summarise(nReads = sum(nReads)) %>% 
  ungroup() %>% 
  filter (taxon != "NA%NA%NA") %>% 
  separate (Sample_name, into = c("eDNA.sample", "rep"), convert = T) -> By.taxa.dataset.metadata

# By.taxa.dataset.metadata %>% write_csv(here("Data", "by.taxa.dataset.metadata.csv"))

```

```{r}
# By.taxa.dataset.metadata <- read_csv(here("Data", "by.taxa.dataset.metadata.csv")) %>% mutate (Transect = as.character(Transect))

eDNA.samples <- read_csv(here("Data","cleaned_CTD_stations.csv"))

base.eDNA <- read_csv(here("Data", "eDNA.samples.with.lat.lon.csv"))

base.eDNA %>% distinct(depth)

base.eDNA %>% 
  mutate (depth  = case_when (depth == "sfc" ~ 0, 
                              TRUE  ~ as.numeric(depth))) %>% 
  unite(Transect, position, sep = "-", col = "Station", remove = F)-> base.eDNA

eDNA.samples %>% 
  select(CTD_Cast, Station, lat, lon) %>% 
  left_join(base.eDNA,.) %>% distinct() -> base.eDNA
  
base.eDNA %>% 
  
group_by(Transect) %>% 
  summarise(xstart = max(lon),
            xend = min(lon),
            ystart = mean(lat),
            yend  = mean(lat))  -> Transects.used

base.eDNA %>% 
  semi_join(By.taxa.dataset.metadata, by = "eDNA.sample") -> eDNA.samples.used

eDNA.samples %>% 
  separate(Station, into = c("Transect", "position"), convert = T) %>% 
  group_by(Transect) %>% 
  summarise(xstart = max(lon),
            xend = min(lon),
            ystart = mean(lat),
            yend  = mean(lat))  -> Transects.total


```


```{r, warning=FALSE}
base_plot <- read_rds(here("Data/Hake_map.rds"))
base_plot +
  geom_segment (data = Transects.total, aes (x = xstart, y = ystart,xend =  xend,yend =  yend, group = Transect), alpha = 0.2) +
  geom_text(data = Transects.total, aes (x =   xend - 0.25,y  =  yend, label = Transect), color = "yellow", fontface = "bold", alpha = 0.2) +
  geom_segment (data = Transects.used, aes (x = xstart, y = ystart,xend =  xend,yend =  yend, group = Transect)) +
  geom_point (data = By.taxa.dataset.metadata %>% distinct(Transect, position, lat, lon), 
              aes(x = lon, y = lat)) +
  geom_label(data = By.taxa.dataset.metadata %>% distinct(Transect, position, lat, lon), 
              aes(x = lon, y = lat, label = position))
```

And a cross section at one of the transects

```{r}

Ole.depth <- read_csv(here ("Data", "Water_depth_consensus.csv")) %>% 
  
  # separate(station, into= c("Transect", "position"), sep = "-") %>% 
   select(Station = station , bottom.depth.consensus)# %>% 
  # filter(!is.na(Transect)) %>% 
  # mutate(Transect = as.numeric(Transect),
  #        position = as.numeric(position))
Samples_with_thermocline <- read_csv(here("Data", "Samples_with_Thermocline.csv")) 

right_join(Ole.depth, Samples_with_thermocline) -> Sample.info

Station.info <- Sample.info %>% 
  select(Station, bottom.depth.consensus, Thermocline_depth, Thermocline_strength, lat, lon) %>% 
  distinct %>% 
  separate(Station, into = "Transect", convert = T, remove = F)
  
Sample.info %>% 
  ggplot(aes(x = Station, y = -depth)) +
 # geom_label (aes(label = eDNA.sample, fill = position), position = "jitter") +
  geom_point(aes(fill = position ),shape = 21, position = "jitter") +
  #  geom_ribbon(aes(ymin = -  bottom.depth.consensus - 20, ymax = -  bottom.depth.consensus + 20), fill = "grey70") +
   geom_line(data = Station.info, aes(x = Station, y = -  Thermocline_depth, color = Thermocline_strength, group = Transect), size = 1.2) + 
 # geom_ribbon(aes(ymin=0, ymax= - bottom.depdth.consensus)) +
  facet_wrap(~reorder(Transect,desc(Transect)),  scales = "free_x", ncol = 1) +
  viridis::scale_color_viridis()+
  theme_minimal()+
  theme(legend.position = "bottom")

```

So we have 8 transects, and in three of them (81, 53 and 26) there is no thermocline in the stations near the coast, in other 2 there is no thermocline in the Offshore (35 and 29) while in the rest there is a strong thermocline.   

### THermocline strength distribution

Nothing too surprising here: stronger thermoclines are shallower than deeper ones.

```{r}
Station.info %>% 
  ggplot(aes(Thermocline_strength)) +
  geom_density_2d_filled(aes( y = Thermocline_depth))
```


## Metadata for analysis

### Label stations as inshore, mid and offshore

```{r}


Sample.info %>%
  separate (Station, into = c(NA, "stop"), remove = F) %>% mutate (stop = as.numeric(stop)) %>% select(eDNA.sample, everything()) %>% 
  #separate()
  # semi_join(By.taxa.dataset.metadata , by = c("Transect", "position" = "stop")) %>% 
  # group_by(Transect) %>% 
  mutate(Openness = case_when (stop == min(stop) ~ "Onshore",
                               stop == max(stop) ~ "Offshore", 
                               TRUE                      ~ "Mid")) -> Step1
 
```

We can label each Station as "Mixed" or "Stratified" Based on Thermocline strength 

```{r}
Step1 %>% 
  distinct(Station, Thermocline_strength) %>% 
  mutate (groups = cut_interval(Thermocline_strength, n = 3),
          groups = case_when(groups == "[-0.00571,1.7]"~ "Mixed",
                             TRUE ~                      "Stratified")) %>% 
  select(-Thermocline_strength) %>% 
  left_join(Step1,.) -> Step2

Step2 %>% 
  distinct(position)

## Recode position so we have three levels: Bottom, above and below

Step2 %>% 
  mutate (Distance_to_thermocline = depth - Thermocline_depth,
          Distance_to_seafloor    = bottom.depth.consensus - depth) %>% 
  mutate(position = case_when(Distance_to_thermocline < 0 ~ "above",
                              Distance_to_thermocline > Distance_to_seafloor ~ "seafloor",
                              TRUE                        ~ "below")) -> Step2


Step2 %>% write_csv(here("Data", "Final_metadata.csv"))
```

# Now to the analysis

Get the Long table and calculate the eDNA index

```{r}
By.taxa.dataset.metadata %>% 
  select(eDNA.sample, rep, taxa, nReads) %>% 
 
  eDNAindex(Sample_column = eDNA.sample,OTU_column = taxa, Counts_column = nReads)  %>%
   left_join(Step2) %>%
  ungroup() %>%
  # group_by(Transect) %>% 
  nest() %>% 
  mutate( bc = map(data, ~tibble_to_matrix(.x, taxon = taxa,Abundance = Normalized.reads, sample.name = eDNA.sample, distance = "bray",transformation = "" )),
         env = map (data, ~tibble_to_env(.x, taxon = taxa, Abundance = Normalized.reads, sample.name = eDNA.sample, everything()) ),
         
         mds.points = map2( bc, env,function(.x, .y){
           monoMDS(.x) -> temp
           
           tibble(MDS1 = temp$points[,1],
                  MDS2 = temp$points[,2]) -> df
            df$eDNA.sample <- as.numeric(dimnames(temp$points)[[1]])
            
            df %>% 
              left_join(.y)
            
           
                  } ),
         
         mds.plot = map(mds.points, function(.x){
           ggplot(.x) +
             geom_point(aes(x = MDS1, y = MDS2, color = Station))
         }),
         
          PERMANOVA = map2(bc, env, function(.x, .y){adonis2(formula = .x ~  position,data = .y, permutations = 9999) })
         ) %>% pull(PERMANOVA) 
  
```


### Exploratory analysis

```{r}

final.metadata <- read_csv(here("Data", "Final_metadata.csv"))
By.taxa.dataset.metadata %>%
  distinct() %>% 
  group_by(eDNA.sample) %>% #mutate(nReads = sum(nReads), prevalence = )
  left_join(final.metadata) %>% 
  group_by(Station, depth) %>% 
  mutate (nsam = n_distinct(eDNA.sample, rep)) %>% 
  group_by(Station, depth, taxon, lat, lon, Transect) %>% 
  summarise(nReads = sum(nReads),
            prevalence = n()/nsam) %>% distinct() %>% ungroup() -> for.explanatory.plots
for.explanatory.plots %>% distinct(taxon)
for.explanatory.plots %>% 
  filter (str_detect(taxon, "Merlu"))

for.explanatory.plots %>% 
  group_by(taxon) %>% 
  summarise(median.lat  = median(lat),
            ave.depth = mean (depth),
            n_samples = n_distinct(Station, depth)) -> sum.stats

sum.stats %>% 
  arrange(ave.depth) %>% 
  filter (n_samples >10)
```

```{r taxa.plotter}
taxa.plotter <- function (df, taxa){
  left.plot <- base_plot +
    geom_point (data = df %>% filter (str_detect(taxon, taxa)),
                aes(x = lon, y = lat, size = prevalence, color = nReads)) +
    viridis::scale_color_viridis()
  
  
  right.plot <- Sample.info %>% 
  ggplot(aes(x = Station, y = -depth)) +
 # geom_label (aes(label = eDNA.sample, fill = position), position = "jitter") +
  geom_point(aes(fill = position ),shape = 21, position = "jitter") +
    geom_point(data = df %>% filter (str_detect(taxon, taxa)),
               aes(x = Station, y = -depth, size = prevalence, color = nReads)) +
    facet_wrap(~reorder(Transect,desc(Transect)),  scales = "free_x", ncol = 1) +
  viridis::scale_color_viridis()+
  theme_minimal()
   left.plot + right.plot +
     plot_annotation(title = taxa) +
     plot_layout(guides = "collect")
}
```

```{r, warning=F, message=F}
for.explanatory.plots %>% 
  taxa.plotter("Merluccius%NA")
```

Head to head plots

```{r comparing plots}

head.2.head <- function (df, taxa1, taxa2 = NULL, ... ){
 if(is.null(taxa2)){
   query <- taxa1 }else{
   query <-base::paste(taxa1,taxa2, sep = "|") }
#  return(query)
   one_plot <- base_plot +
    geom_point (data = df %>% filter (str_detect(taxon, query)),
                aes(x = lon, y = lat, size = prevalence, color = nReads)) +
    viridis::scale_color_viridis() +
     facet_wrap(~taxon, nrow = 1)
   
   other_plot <-  df %>% 
     distinct(Station, depth) %>% 
     # filter (str_detect(taxon, query)) %>% 
     ggplot (aes(x = depth)) +
     geom_density(fill = "grey")+
       geom_density(data = df %>% filter (str_detect(taxon, query)),
                    aes(x = depth, fill = taxon),
                     alpha = 0.5) #+
    # facet_wrap(~taxon, nrow  = 1)
   
   one_plot +
     other_plot +
     plot_layout(ncol = 1)
}


# with two qqueries
for.explanatory.plots %>% 
head.2.head("Clupea pallasii", "Trachurus symmetricus")
# with one query, but two or three taxon
for.explanatory.plots %>% 
  head.2.head(taxa1 = "Merluccius")
# with all three cases
for.explanatory.plots %>% 
  head.2.head(taxa1 = "Myctophidae")
```

```{r}
library(ggExtra)
base_plot +
    geom_point (data = for.explanatory.plots %>% filter (str_detect(taxon, "Clupea pallasii|Trachurus symmetricus")),
                aes(x = lon, y = lat, size = prevalence, color = nReads)) +
 
    viridis::scale_color_viridis() +
 #    facet_wrap(~taxon, nrow = 1)+
  theme(legend.position = "bottom") -> main.pot 

  ggMarginal(main.pot,
             data = for.explanatory.plots %>% filter (str_detect(taxon, "Clupea pallasii|Trachurus symmetricus")), 
             y = lat, x = lon,
             type = "densigram", 
             margins = "y"
  )
  
  for.explanatory.plots %>% filter (str_detect(taxon, "Clupea pallasii|Trachurus symmetricus")) %>% 
    ggplot (aes(x = lat, fill = taxon)) + ge
```

```{r}

```

