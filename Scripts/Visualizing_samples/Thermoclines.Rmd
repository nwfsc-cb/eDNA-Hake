---
title: "Thermoclines"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

We want to map  which stations have a marked thermocline, and which don't. We want to choose a few stations from each and build a test like so



```{r}
library(tidyverse)
library(rLakeAnalyzer)
library(castr)
library(here)
library(kableExtra)
```


Import all the CTD casts we need

```{r List of CTD casts to import}

all.CTDS.to.keep <- read_csv("cleaned_CTD_stations.csv")

files.inCTD <- list.files(path = "../Data/1_converted/", pattern = "*.csv")

# Are they all present

files.inCTD <- tibble (file.name = list.files(path = "../Data/1_converted/", pattern = "*.csv"),
                       path = list.files(path = "../Data/1_converted/", pattern = "*.csv", full.names = T))

safe_read <- possibly(read_csv, otherwise = NA)

all.CTDS.to.keep %>% 
  
  mutate(CTD_Cast = case_when(CTD_Cast < 100 ~ paste0 ("0", CTD_Cast),
                              TRUE           ~ as.character(CTD_Cast))) %>% 
  group_by(CTD_Cast) %>% 
  nest() %>%
  mutate(CTD_Data = map (CTD_Cast, ~ safe_read(file = glue::glue("../Data/1_converted/", .x, ".csv")))) -> all.CTDS.to.keep


```

# Calculate the thermocline

```{r}
 

all.CTDS.to.keep %>% #mutate (clas = map (CTD_Data, class))
  filter (!is.na(CTD_Data)) %>%  # Takes forever
  mutate (CTD_Data = map (CTD_Data, ~.x %>% mutate_at (c("Temperature (degC)", "Salinity (psu)", "Oxygen (ml_per_l)", "Fluorescence (ug_per_l)"), .funs = despike)),
          Thermocline = map_dbl (CTD_Data, ~ .x %>% summarise( thermocline = clined(`Temperature (degC)`, `Depth (m)`)) %>% pull)) -> thermocline2

# thermocline2 %>% 
#   mutate(Thermocline = map_dbl (Thermocline, ~ .x %>% pull)) -> thermocline2

list.of.stations.to.keep <- read_csv("cleaned_CTD_stations.csv")

list.of.stations.to.keep %>% mutate(CTD_Cast = case_when(CTD_Cast < 100 ~ paste0("0",CTD_Cast),
                                                         TRUE           ~ as.character(CTD_Cast))) -> list.of.stations.to.keep
```

## Join thermocline depths with lat lon

```{r}
thermocline2 %>% 
  mutate(Temp_above = map2_dbl(CTD_Data, Thermocline,~ .x %>%
                                 filter(`Depth (m)` < .y) %>%
                                 summarise(mean(`Temperature (degC)`, na.rm = T)) %>%
                                 pull),
         Temp_below = map2_dbl(CTD_Data, Thermocline,~ .x %>%
                                 filter(`Depth (m)` > .y, `Depth (m)` < .y + 20) %>% 
                                 summarise(mean(`Temperature (degC)`, na.rm = T)) %>% 
                                 pull),
         SST = map_dbl(CTD_Data , ~.x %>% 
                          filter (`Depth (m)` < 10) %>% 
                          summarise(mean (`Temperature (degC)`, na.rm = T)) %>% 
                          pull)) %>% 
  mutate (Temp_diff = map2_dbl (Temp_above, Temp_below, ~.x - .y)) %>% 
  dplyr::select(CTD_Cast, Thermocline, Temp_diff, SST) %>% 
  left_join(list.of.stations.to.keep) -> data.with.lat

write_rds(data.with.lat, here("Data", "thermocline.data.for.plotting.rds"))
```

```{r}

data.with.lat <- read_rds(here("Data", "thermocline.data.for.plotting.rds"))
base.map.Hake <- read_rds(here("Data", "Hake_map.rds"))
data.with.lat %>% 
  ggplot(aes(x = Thermocline, y = lat, size = Temp_diff)) +
  geom_point(alpha = 0.5)

data.with.lat %>% 
  ggplot(aes(x = Thermocline, y = Temp_diff))+
  geom_smooth() +
  geom_jitter()

data.with.lat %>% 
  ggplot(aes(x = lat, y = Temp_diff))+
  geom_smooth()

data.with.lat %>% 
   mutate_at(c("lat", "lon"), ~round(.x, 1)) %>% 
  ggplot()+
  geom_boxplot(aes(x = as.factor(lat), y  = SST))

data.with.lat %>% 
  mutate_at(c("lat", "lon"), ~round(.x, 1)) %>% 
  
  ggplot(aes(x = lon, y = lat))+
  geom_point(aes(fill = Temp_diff, color = Thermocline < 20 ), shape = 21, size = 3, stroke =1.5) +
  scale_color_viridis_c(aesthetics = "fill")+
  scale_color_brewer(palette = "Accent") +theme_minimal() +coord_equal()

data.with.lat %>% 
  mutate_at(c("lat", "lon"), ~round(.x, 1)) %>% 
  
  ggplot(aes(x = lon, y = lat))+
  geom_point(aes(fill = SST), shape = 21, size = 3, stroke =1.5) +
  scale_color_viridis_c(aesthetics = "fill")+
  scale_color_brewer(palette = "Accent") +theme_minimal() +coord_equal()

base_map_hake +
  geom_point(data = data.with.lat %>% filter(Thermocline < 20), aes(x = lon, y = lat ), size = 4, color = "red")+
  geom_point(data = data.with.lat, aes(x = lon, y = lat, color = Temp_diff ) ,size = 2.5) +
  
  scale_color_viridis_c() + 
  theme(legend.position = "bottom")+
  guides(fill = "none") -> Temp.diff.plot
  
base_map_hake +
  geom_point(data = data.with.lat, aes(x = lon, y = lat), color = "black", size = 3) +
  geom_point(data = data.with.lat, aes(x = lon, y = lat, color = SST ) ,size = 2.5) +
  
  scale_color_distiller(palette = "Spectral") +
  guides(fill = "none") + 
  theme(legend.position = "bottom") -> sst.plot



base_map_hake +
  geom_text(data = data.with.lat %>% 
               separate(Station, into = c("transect", "station")), aes(x = lon, y = lat, label = station ) ,size = 2.5, fontface = "bold") +
  geom_segment (data = Transects, aes (x = xstart, y = ystart,xend =  xend,yend =  yend, group = Transect)) +
    geom_text(data = Transects, aes (x =   xend - 0.25,y  =  yend, label = Transect), color = "yellow", fontface = "bold")+ 
  theme(legend.position = "bottom") +
  labs(fill ="depth" )-> station.plot

library(cowplot)
library(patchwork)
legend_left <- get_legend(Temp.diff.plot)
legend_right <- get_legend(sst.plot)
# needs work
legends <- cowplot::plot_grid(list(legend_left, legend_right))

Temp.diff.plot +
sst.plot +station.plot
  ggsave(here("Plots and figures","plots.for.choosing.png"), height=10,width = 10, dpi = 300 )

```

```{r}
station.plot +
theme(legend.key.width = unit( 0.5, "in" ))
ggsave(
# ggsave(plot = station.plot,
filename =  here("Plots and figures", "station.plot.png"),
height = 10, width = 4, dpi = "retina")

```

# Get the fluoresence

We will use this to get the value of the water fluoresence on the 5m above and below the sample

```{r}

eDNA.samples %>% 
  select(Station, depth, `Tube #`) %>% 
  mutate(depth = case_when(is.na(as.numeric(depth)) ~ 5,
                           TRUE                     ~ as.numeric(depth) ))%>% 
  left_join(read_csv("cleaned_CTD_stations.csv") %>%
              select(Station, CTD_Cast) ) %>% 
  inner_join(thermocline2 %>% 
              ungroup() %>% 
              mutate(CTD_Cast = as.numeric(CTD_Cast))) %>% 
  ungroup() %>% 
  mutate(Flour_at_sample = map2_dbl(CTD_Data, depth, ~.x %>% 
                                  filter(between(`Depth (m)` , left =  .y -2.5, right = .y + 2.5 )) %>% 
                                  summarise(Flour = mean (`Fluorescence (ug_per_l)`, na.rm = T) ) %>% 
                                  pull()) ) -> Samples.with.Flour
  
Samples.with.Flour %>% 
  select(Station, depth, Tube = `Tube #`, Flour_at_sample) %>% 
  write_csv(here("Data", "Flouresnce_by_sample.csv"))
Samples.with.Flour <- read_csv(here("Data", "Flouresnce_by_sample.csv"))
Samples.with.Flour %>% 
  separate(Station, into = c("Transect", NA), remove = F) %>% 
  ggplot(aes(x = Flour_at_sample, y = depth, color = Station, group = Station)) +
  geom_line() +
  facet_wrap(~Transect) +
  scale_y_reverse()+
  guides(color = "none") +
  ggsave(filename = here("Plots and figures", "Fluoresence_at_Station.png"),
        width = 14, height = 10, dpi = "retina")

Samples.with.Flour %>% 
  select (Station, depth, Tube = `Tube #`, Flour_at_sample) %>% 
  separate(Station, into = c("Transect", NA), remove = F) %>% 
  ggplot(aes(x = Flour_at_sample, y = depth, color = Station, group = Station)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Transect) +
  scale_y_reverse()+
  guides(color = "none") +
  ggsave(filename = here("Plots and figures", "Fluoresence_at_Station_points_lines.png"),
        width = 14, height = 10, dpi = "retina")


# Stations in transect Side -by- side

Samples.with.Flour %>% 
  select (Station, depth, Tube = `Tube #`, Flour_at_sample) %>% 
  separate(Station, into = c("Transect", NA), remove = F) %>% 
  ggplot(aes(x = Station, y = depth, color = Flour_at_sample, size = Flour_at_sample)) +
  geom_point() +
 # geom_line() +
  facet_wrap(~Transect, scales = "free") +
  scale_y_reverse()+
  scale_color_viridis_c(name = "Fluorescence",) +
  scale_size_continuous(name = "Flourescence") +
  theme(legend.position = c(0.85,0.08),
        legend.direction = "horizontal") +
  #guides(color = "bottom") +
  ggsave(filename = here("Plots and figures", "Fluorescence_at_Stations.png"),
        width = 14, height = 10, dpi = "retina")

```


# Summary of Samples collected
```{r}
eDNA.samples %>% 
  separate(Station, into = c("Transect", "Station")) %>% 
  mutate(category = case_when(depth == "-" ~ "Extraction Control",
                              TRUE         ~ "eDNA Sample")) %>% 
  group_by(category) %>% 
 summarise(tot = n(),
           Transects = n_distinct(Transect),
           Stations = n_distinct(Transect, Station)) %>% 
  kable(.) %>% 
  kable_styling()

```


