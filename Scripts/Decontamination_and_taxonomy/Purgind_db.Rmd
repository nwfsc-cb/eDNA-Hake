---
title: "Removing Sternoptyx obscura"
output: html_notebook
---

There are a few instances in which the consensus ID is reduced to the order level or higher because there are a few sequences that share seq with a different species but not with other similar seqs from the same species

```{r}
library(here)
library(tidyverse)
library(insect)
library(rentrez)
set_entrez_key("c7f054eeed8138a4c66f908db525226fb208")
```

# Download the offending results

These are the sequences that BLAST against our queries, but the LCA returns nothing

```{r}
new.BLAST <- read_table(here("Data", "blast_results.txt"),  col_names = c("Hash", "Match", "pident", "length", "mismatch", "gapopen", "qstart","qend" , "sstart", "send", "evalue", "bitscore", "taxid", "qlen")) %>% 
  separate_rows("taxid",sep =  ";", convert = T)

new.lineages <- read_csv(here("Data", "lineages_new_blast.csv"))

new.BLAST %>% 
  filter (length >275) %>% 
  left_join(new.lineages)
```

## EU099498

This is a sequence 100% similar to a bunch of *Engraulis mordax*, but assigned to *Sternoptyx obscura*. Is it similar to other Sternoptyx sequences?

```{r}
query <- "Sternoptyx[ORGN]+OR+Engraulis[ORGN]"



Full.search <- searchGB(query,taxIDs = T, sequences = T )

# Remove infamous sequence

Full.search["EU099498|81875"] -> offending

Full.search["EU099498|81875"] <- NA

Full.search %>% purrr::compact()

Prey_for <- "GYAATCACTTGTCTTTTAAATGAAGACC"
Prey_rev <- "GGATTGCGCTGTTATCCCTA"

Prey16s <- virtualPCR(Full.search, up = Prey_for, down = Prey_rev,
                             trimprimers = TRUE,minamplen = 250, maxamplen = 400, cores = "autodetect")
worlds.taxonomy <- read_rds(here("Data", "all.taxonomy.rds"))

writeFASTA(Prey16s, file = here("Data", "all_seqs_db.fasta"))

new.tree <- learn(Prey16s, worlds.taxonomy)

insect::classify(x = offending, tree = new.tree, ping = T)
```


