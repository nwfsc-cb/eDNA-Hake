---
title: "Using a Drichelet regression"
output: html_notebook
---
In order to compare communities (samples) based on their composition (as a vector of proportions) and see their changes as a function of Latitude (Transect),  depth and more importantly due to the presence of a thermocline

```{r}
library (tidyverse)
library (here)
library(DirichletReg)


```

The first task is preparing the data in the format required by the function (`DirichReg`): A wide dataframe with an extra column in which the biological data is standarized by proportions.

Besides preparing the data, two layers of complexity need to be addressed. 
  * First: do we keep actual species or shall we collapse them further into functional units (eg. sharks, flounders, Rockfishes, )
  * Second: Shall we collapse technical replicates (sure)  but also biological replicates?

# Option1. Keeping biological replicates separate
 
```{r}
By.taxa.dataset <- read_csv(here("Data",  "by.taxa.dataset.metadata.csv")) %>% mutate (Transect = as.character(Transect))

metadata  <- read_csv(here("Data", "Final_metadata.csv"))

By.taxa.dataset %>% 
  select(eDNA.sample,  taxa, nReads) %>% 
  group_by(eDNA.sample, taxa) %>% 
  summarise (nReads = sum(nReads)) %>% 
  pivot_wider (names_from = taxa, values_from = nReads, values_fill = 0) -> wide.biol 
wide.biol %>%    
left_join(metadata) %>%
  column_to_rownames("eDNA.sample")   -> ready.for.multivariate

ready.for.multivariate %>% 
  mutate(Y = DR_data(wide.biol %>% column_to_rownames("eDNA.sample"))) -> ready.for.multivariate
```
  
## Not collapsing taxa

The formula should be
Com ~ Transect (factor) +
Offshoreness or bottom_depth (factor) +
Upwelling (factor) +
                    	Error (among sample variability) 

```{r}
test1 <- DirichReg(Y ~ as.factor(Transect) + position +  groups, data = ready.for.multivariate , model = "alternative")

test1
```
Turns out if we try to estimate sigma for all spp then it takes forever
 
 
 Ole suggestes 
 dna.index ~ transect + depth + upwelling
 
## Collapsing taxa

Bring up a list of all taxa

```{r}
By.taxa.dataset %>% 
  ungroup() %>% 
  distinct(taxa) %>% 
  arrange() %>% 
  separate(taxa, into = c("family", "genus", "species"), extra = "merge", remove = F) %>% 
  write_csv(here("Data", "unique.sp.csv"))

By.taxa.dataset %>% 
  group_by(taxa) %>% 
  summarise(nReads = sum(nReads),
            npoints = n_distinct(Transect,position,depth)) %>% 
  write_csv(here("Data", "taxa.counts.csv"))
```

### Load list of major groups

```{r}
sp_groups <- read_csv(here("Data", "unique.sp_collapse.csv"))

sp_groups %>% 
  select(taxa, morpho.group = new.morphotype, habitat = `habitat use`, final.morphotype = 13 ) -> grouping

# Combine even furhter

grouping %>% 
  mutate(collapsed = case_when(str_detect (final.morphotype, "Marine; freshwater; brackish; pelagic-neritic") ~ "Coastal;pelagic-neritic",
                               str_detect(final.morphotype, "pelagic-neritic") ~ "Open; pelagic-neritic",
                               str_detect(final.morphotype, " brackish; demersal")~ "Coastal; demersal",
                               str_detect(final.morphotype, "demersal"  )          ~ "Open; demersal",
                               str_detect(final.morphotype, "brackish; benthopelagic"  )          ~ "Coastal; benthopelagic",
                               
         TRUE       ~ final.morphotype)) -> grouping

grouping %>%  distinct(final.morphotype) %>% View
# grouping %>% 
#   filter (is.na(final.morphotye))
```

### COllapse

```{r}

By.taxa.dataset %>% 
  filter(!str_detect(taxa, "Cich")) %>% 
   left_join(grouping) %>% 
  # select(eDNA.sample,  final.morphotype, nReads) %>% 
  group_by(eDNA.sample, collapsed) %>% 
  summarise (nReads = sum(nReads)) %>% 
  filter(!is.na(collapsed )) %>% 
  pivot_wider (names_from = collapsed, values_from = nReads, values_fill = 0) -> wide.biol

wide.biol %>% 
  #no tilapias
  left_join(metadata %>% 
              select(eDNA.sample, Transect, position, Openness, groups, depth)) %>% 
  column_to_rownames("eDNA.sample") -> ready.by.cat

ready.by.cat %>% 
  mutate(Transect = as.factor(Transect)) -> ready.by.cat

Y <-  DR_data(wide.biol%>% 
  column_to_rownames("eDNA.sample"))


```

### Fitting


```{r}
test1 <- DirichReg(Y ~ Transect + depth +  groups, data = ready.by.cat , model = "alternative")

augmented.df <- ready.by.cat %>%  distinct(Transect,groups ) %>% 
  group_by(Transect,groups) %>% 
  nest() %>% 
  mutate(depth = map(data,~ tibble (depth = seq(0,500, by = 20)) )) %>% 
  select(-data) %>% 
  unnest(depth)
interaction(depth = 1:500)

predict(test1, augmented.df, T,T,T) %>% 
  map(~ as_tibble(.x) %>%
 bind_cols(augmented.df)) -> predictions

colnames(predictions[[1]])[1:8] <- colnames(ready.by.cat)[1:8]

```

# Plot

```{r}
predictions[[1]] %>% 
```

