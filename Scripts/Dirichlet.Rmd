---
title: "Using a Drichelet regression"
output: html_notebook
---
In order to compare communities (samples) based on their composition (as a vector of proportions) and see their changes as a function of Latitude (Transect),  depth and more importantly due to the presence of a thermocline

```{r}
library (tidyverse)
library (here)
library(DirichletReg)


```

The first task is preparing the data in the format required by the function (`DirichReg`): A wide dataframe with an extra column in which the biological data is standarized by proportions.

Besides preparing the data, two layers of complexity need to be addressed. 
  * First: do we keep actual species or shall we collapse them further into functional units (eg. sharks, flounders, Rockfishes, )
  * Second: Shall we collapse technical replicates (sure)  but also biological replicates?

# Option1. Keeping biological replicates separate
 
```{r}
By.taxa.dataset <- read_csv(here("Data",  "by.taxa.dataset.metadata.csv")) %>% mutate (Transect = as.character(Transect))

metadata  <- read_csv(here("Data", "Final_metadata.csv"))

By.taxa.dataset %>% 
  select(eDNA.sample,  taxa, nReads) %>% 
  group_by(eDNA.sample, taxa) %>% 
  summarise (nReads = sum(nReads)) %>% 
  pivot_wider (names_from = taxa, values_from = nReads, values_fill = 0) -> wide.biol 
wide.biol %>%    
left_join(metadata) %>%
  column_to_rownames("eDNA.sample")   -> ready.for.multivariate

ready.for.multivariate %>% 
  mutate(Y = DR_data(wide.biol %>% column_to_rownames("eDNA.sample"))) -> ready.for.multivariate
```
  
## Not collapsing taxa

The formula should be
Com ~ Transect (factor) +
Offshoreness or bottom_depth (factor) +
Upwelling (factor) +
                    	Error (among sample variability) 

```{r}
test1 <- DirichReg(Y ~ as.factor(Transect) + position +  groups, data = ready.for.multivariate , model = "alternative")

test1
```
Turns out if we try to estimate sigma for all spp then it takes forever
 
 
 Ole suggestes 
 dna.index ~ transect + depth + upwelling
 
## Collapsing taxa

Bring up a list of all taxa

```{r}
By.taxa.dataset %>% 
  ungroup() %>% 
  distinct(taxa) %>% 
  arrange() %>% 
  separate(taxa, into = c("family", "genus", "species"), extra = "merge", remove = F) %>% 
  write_csv(here("Data", "unique.sp.csv"))

By.taxa.dataset %>% 
  group_by(taxa) %>% 
  summarise(nReads = sum(nReads),
            npoints = n_distinct(Transect,position,depth)) %>% 
  write_csv(here("Data", "taxa.counts.csv"))
```

### Load list of major groups

```{r}
sp_groups <- read_csv(here("Data", "unique.sp_collapse.csv"))

sp_groups %>% 
  select(taxa, morpho.group = new.morphotype, habitat = `habitat use` ) -> grouping

grouping %>%  distinct(morpho.group)

```

### COllapse

```{r}
By.taxa.dataset %>% 
  filter(!str_detect(taxa, "Cich")) %>% #no tilapias
  left_join(grouping) %>% 
  unite (Transect, position, depth, col = "META", sep = "|") %>% 
  group_by(META,  morpho.group) %>% 
  # left_join(metadata, )
  summarise (nReads = sum(nReads)) %>% 
  # select(-habitat) %>% ungroup %>% 
  # mutate(eDNA.sample = as.character(eDNA.sample)) %>% 
  pivot_wider(names_from = morpho.group, values_from = nReads, values_fill = 0) %>% 
  pivot_longer(-META,  names_to = "taxa", values_to = "nReads") %>% 
  group_by(taxa,  Zeroes = nReads ==0) %>% 
  tally() %>% 
  filter (Zeroes == T) %>% 
  arrange(n)

```

