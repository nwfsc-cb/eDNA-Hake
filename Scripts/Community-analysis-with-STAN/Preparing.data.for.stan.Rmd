---
title: "Preparing data for STAN"
author: "Ramon Gallego"
date: "9/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r  libraries}
library(tidyverse)
library(rstan)
library(bayesplot)
library(here)
options(mc.cores = parallel::detectCores())
rstan_options("auto_write" = TRUE)

create.index <- function (column){
  x <- as.factor(column)
  x <- as.numeric(x)
  return(x)
}

```

## Data

In Calcofi, there is one biological replicate (a jar) and up to three tech replicates. Here I have 2 bottles of water next to each other, and 2 replicates per bottle.

We will talk with Ole and change it, but to start with we are going to take every bottle of water as a technical replicate - so for each station/depth we have up to 4 tech replicates

```{r pressure, echo=FALSE}
init.data <- read_csv(here("Data", "Data_for_STAN.csv"))

init.data %>% 
  unite (eDNA.sample, rep,col = "rep", sep = ".") %>% 
  unite (Transect, position, depth, col = "bio", sep = ".") %>% 
  distinct(rep, bio) %>% 
  group_by(bio) %>% 
  nest() %>% 
  mutate(data = map (data, rownames_to_column, "reps") ) %>% 
  unnest(data) %>% 
  select(-bio)-> key.to.bios

init.data %>% 
  unite (eDNA.sample, rep,col = "rep", sep = ".") %>% 
  left_join(key.to.bios) %>% 
  select(-rep) -> init.data

I_fish <- n_distinct(init.data$func.group) # How many spp/taxa/groups

replication.matrix <- init.data %>% group_by(Transect, position, depth) %>% summarise(nrep = n_distinct(reps)) # How many reps per bottle of water
K_fish <- nrow(replication.matrix) # how man
J_fish <- max (replication.matrix$nrep)
J_fish_vec <- replication.matrix$nrep
N_station_species <- nrow(init.data %>% distinct(func.group, Transect, position, depth))
N_fish_obs <- nrow(init.data)
D_fish_obs <- init.data$nReads

init.data %>% 
  unite(bio,reps, col = "tech", remove = F) %>% 
  mutate(statio_rep_idx = create.index(tech)) -> init.data

N_fish_station_rep_idx <- n_distinct(init.data$statio_rep_idx)

N_pcr_fish <- 43 ## Adding PCr1 and 2 - but the process is different


## Create indices

fish_station_idx <- # Index of each station (no biol)

fish_sp_idx

fish_station_rep_idx
```

